{"version":3,"sources":["../../routes/auth.js"],"names":["setUpAuth","Donor","app","passport","require","FacebookStrategy","Strategy","serializeUser","user","done","_id","deserializeUser","id","findOne","exec","use","clientId","process","env","FACEBOOK_CLIENT_ID","clientSecret","FACEBOOK_CLIENT_SECRET","callbackURL","accessToken","refreshToken","profile","emails","length","findOneAndUpdate","$set","value","toString","upsert","runValidators","error","donor","secret","initialize","session","get","authenticate","scope","failureRedirect","req","res","send","username","module","exports"],"mappings":";;AAAA;;;;AAIA,IAAIA,SAAJ;;AAEAA,YAAY,mBAACC,KAAD,EAAQC,GAAR,EAAgB;AAC3B,KAAIC,WAAWC,QAAQ,UAAR,CAAf;AACA,KAAIC,mBAAmBD,QAAQ,mBAAR,EAA6BE,QAApD;;AAEAH,UAASI,aAAT,CAAuB,UAACC,IAAD,EAAOC,IAAP,EAAgB;AACtCA,OAAK,IAAL,EAAWD,KAAKE,GAAhB;AACA,EAFD;;AAIAP,UAASQ,eAAT,CAAyB,UAACC,EAAD,EAAKH,IAAL,EAAc;AACtCR,QAAMY,OAAN,CAAc,EAACH,KAAKE,EAAN,EAAd,EAAyBE,IAAzB,CAA8BL,IAA9B;AACA,EAFD;;AAIAN,UAASY,GAAT,CAAa,IAAIV,gBAAJ,CACZ;AACCW,YAAUC,QAAQC,GAAR,CAAYC,kBADvB;AAECC,gBAAcH,QAAQC,GAAR,CAAYG,sBAF3B;AAGCC,eAAa;AAHd,EADY,EAMN,UAACC,WAAD,EAAcC,YAAd,EAA4BC,OAA5B,EAAqChB,IAArC,EAA8C;AACrD,MAAI,CAACgB,QAAQC,MAAT,IAAmB,CAACD,QAAQC,MAAR,CAAeC,MAAvC,EAA+C,OAAOlB,KAAK,yCAAL,CAAP;;AAE/CR,QAAM2B,gBAAN,CACe,EAAC,aAAaH,QAAQb,EAAtB,EADf,EAEC;AACCiB,SAAM;AACL,oBAAgBJ,QAAQC,MAAR,CAAe,CAAf,EAAkBI,KAD7B;AAEL,uBAAoB,+BAA8BL,QAAQb,EAAR,CAAWmB,QAAX,EAA9B,GAAqD;AAFpE;AADP,GAFD,EAQC;AACC,UAAQ,IADT;AAECC,WAAS,IAFV;AAGCC,kBAAgB;AAHjB,GARD,EAYG,UAACC,KAAD,EAAQC,KAAR,EAAkB;AACnB1B,QAAKyB,KAAL,EAAYC,KAAZ;AACA,GAdF;AAgBA,EAzBa,CAAb;;AA6BAjC,KAAIa,GAAJ,CAAQX,QAAQ,iBAAR,EAA2B,EAACgC,QAAQ,kBAAT,EAA3B,CAAR;;AAEAlC,KAAIa,GAAJ,CAAQZ,SAASkC,UAAT,EAAR;;AAEAnC,KAAIa,GAAJ,CAAQZ,SAASmC,OAAT,EAAR;;AAEApC,KAAIqC,GAAJ,CAAQ,gBAAR,EAAyBpC,SAASqC,YAAT,CAAsB,UAAtB,EAAiC,EAACC,OAAM,CAAC,OAAD,CAAP,EAAjC,CAAzB;;AAEAvC,KAAIqC,GAAJ,CAAQ,yBAAR,EAAkCpC,SAASqC,YAAT,CAAsB,UAAtB,EAAiC,EAACE,iBAAgB,OAAjB,EAAjC,CAAlC,EACM,UAACC,GAAD,EAAMC,GAAN,EAAc;AACpBA,MAAIC,IAAJ,CAAS,SAAT,EAAoBF,IAAInC,IAAJ,CAASiB,OAAT,CAAiBqB,QAArC;AACA,EAHA;AAQA,CAzDD;;AA2DAC,OAAOC,OAAP,GAAiBhD,SAAjB","file":"auth.js","sourcesContent":["/**\n * Created by chrisp on 19/02/2017.\n */\n\nvar setUpAuth;\n\nsetUpAuth = (Donor, app) => {\n\tlet passport = require(\"passport\");\n\tlet FacebookStrategy = require(\"passport-facebook\").Strategy;\n\n\tpassport.serializeUser((user, done) => {\n\t\tdone(null, user._id);\n\t});\n\n\tpassport.deserializeUser((id, done) => {\n\t\tDonor.findOne({_id: id}).exec(done);\n\t});\n\n\tpassport.use(new FacebookStrategy(\n\t\t{\n\t\t\tclientId: process.env.FACEBOOK_CLIENT_ID,\n\t\t\tclientSecret: process.env.FACEBOOK_CLIENT_SECRET,\n\t\t\tcallbackURL: \"http://localhost:3000/auth/facebook/callback\"\n\t\t},\n        (accessToken, refreshToken, profile, done) => {\n\tif (!profile.emails || !profile.emails.length) return done(\"No emails associated with this account!\");\n\n\tDonor.findOneAndUpdate(\n                {\"data.auto\": profile.id},\n\t\t{\n\t\t\t$set: {\n\t\t\t\t\"profile.name\": profile.emails[0].value,\n\t\t\t\t\"profile.picture\" : \"http://graph.facebook.com/\"+ profile.id.toString() +\"/picture?type=large\"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"new\" : true,\n\t\t\tupsert : true,\n\t\t\trunValidators : true\n\t\t},(error, donor) => {\n\t\t\tdone(error, donor);\n\t\t}\n            );\n}\n    ));\n\n\n\tapp.use(require(\"express-session\")({secret: \"This is a secret\"}));\n\n\tapp.use(passport.initialize());\n\n\tapp.use(passport.session());\n\n\tapp.get(\"/auth/facebook\",passport.authenticate(\"facebook\",{scope:[\"email\"]}));\n\n\tapp.get(\"/auth/facebook/callback\",passport.authenticate(\"facebook\",{failureRedirect:\"/fail\"}),\n       (req, res) => {\n\tres.send(\"Welcome\", req.user.profile.username);\n});\n\n\n\n\n};\n\nmodule.exports = setUpAuth;"]}