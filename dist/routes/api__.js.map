{"version":3,"sources":["../../routes/api__.js"],"names":["express","status","bodyParser","api","compute","handleMany","require","module","exports","wagner","Router","use","json","put","invoke","Donor","req","res","doner","body","donor","e","BAD_REQUEST","error","save","user","INTERNAL_SERVER_ERROR","toString","get","find","$and","$gte","params","log","range","$lte","lat","bloodgroup","score","$meta","sort","limit","parseFloat","exec","bind","BloodGroup","_id","a","b","property","result","NOT_FOUND"],"mappings":"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","file":"api__.js","sourcesContent":["//noinspection Eslint\n/**\n * Created by chrisp on 24/08/2016.\n */\n\nlet express, status, bodyParser, api, compute, handleMany;\n\nexpress = require(\"express\");\nstatus = require(\"http-status\");\nbodyParser = require(\"body-parser\");\n\nmodule.exports = (wagner) => {\n\tapi = express.Router();\n\n\tapi.use(bodyParser.json());\n\n\tapi.put(\"/donor/add\", wagner.invoke((Donor)=> {\n\t\treturn (req, res)=> {\n\t\t\ttry {\n\t\t\t\tvar doner = req.body.donor;\n\t\t\t} catch (e) {\n\t\t\t\treturn res.status(status.BAD_REQUEST).json({error: \"No cart specified! \"});\n\t\t\t}\n\n\t\t\treq.body.donor= doner;\n\t\t\treq.body.donor.save((error, user)=> {\n\t\t\t\tif (error) return res.status(status.INTERNAL_SERVER_ERROR).json({error: error.toString()});\n\t\t\t\treturn res.json({user: user});\n\t\t\t});\n\t\t};\n\t}));\n\n\n    // Simple rest api to return the cordinates\n\tapi.get(\"/donor/search/:lat/:log/:limit/:range/:bloodgroup\", wagner.invoke((Donor)=> {\n\t\treturn (req, res)=> {\n\t\t\tDonor.find(\n\t\t\t\t{\n\t\t\t\t\t$and: [\n                        {$and: [{\"location.geoLong\": {$gte :compute (req.params.log ,- req.params.range)}}, {\"location.geoLat\":{$lte :  compute(req.params.log , req.params.range)}}]},\n                        {$and: [{\"location.geoLat\": {$gte : compute(req.params.lat , - req.params.range)}}, {\"location.geoLat\":{$lte :  compute(req.params.lat,  req.params.range)}}]},\n                        {\"bloodGroup.canDonateTo\":req.params.bloodgroup}\n\t\t\t\t\t]\n\t\t\t\t}\n                , {score: {$meta: \"textScore\"}}).sort({score: {$meta: \"textScore\"}}).limit(parseFloat(req.params.limit)).exec(handleMany.bind(null, \"donors\", res));\n\t\t};\n\t}));\n\n\tapi.get(\"/bloodgroup/list\",wagner.invoke((BloodGroup)=>{\n\t\treturn (req,res)=>{\n\t\t\tBloodGroup.find().sort({_id: 1}).exec( handleMany.bind(null, \"bloodgroups\", res));\n\t\t};\n\t}));\n\n\n\treturn api;\n};\n\n// var handleOne = (property, res, error, result)=> {\n//     console.log(result);\n//     console.log(property);\n//     if (error) return res.status(status.INTERNAL_SERVER_ERROR).json({error: error.toString()});\n//     if (!result) return res.status(status.NOT_FOUND).json({error: \"Not found\"});\n//     var json = {};\n//     json[property] = result;\n//     res.json(json);\n// };\n\ncompute= (a,b)=> {return parseFloat(a)+parseFloat(b);};\n\nhandleMany = (property, res, error, result)=> {\n\tif (error) return res.status(status.INTERNAL_SERVER_ERROR).json({error: error.toString()});\n\tif (!result) return res.status(status.NOT_FOUND).json({error: \"Not found\"});\n\tvar json = {};\n\tjson[property] = result;\n\tres.json(json);\n};\n\n"]}